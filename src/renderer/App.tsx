import React, { useState, useEffect, useMemo } from 'react';
import { Shield, Info, Search, Edit3, Clock, ChevronRight, Filter, FileText, CheckCircle2, AlertCircle, Trash2 } from 'lucide-react';
import styles from './styles/App.module.scss';
import { useStore } from './store/useStore';

const guidelineNames: Record<string, string> = {
  "ALL": "ì „ì²´ ì§€ì¹¨",
  "1.1": "1.1 ëŒ€ì²´ í…ìŠ¤íŠ¸",
  "1.2": "1.2 ìë§‰ ì œê³µ",
  "2.1.1": "2.1.1 í‚¤ë³´ë“œ ì‚¬ìš©",
  "2.1.3": "2.1.3 ì¡°ì‘ ê°€ëŠ¥",
  "2.3.1": "2.3.1 ë²ˆì©ì„ ì œí•œ",
  "2.4.1": "2.4.1 ê±´ë„ˆë›°ê¸° ë§í¬",
  "2.4.2": "2.4.2 ì œëª© ì œê³µ",
  "2.4.3": "2.4.3 ë§í¬ í…ìŠ¤íŠ¸"
};

const App = () => {
  const { items, setItems, updateItemStatus, clearItems, projectName } = useStore();
  const [selectedId, setSelectedId] = useState<string | null>(null);
  const [judgingId, setJudgingId] = useState<string | null>(null);
  const [tempComment, setTempComment] = useState("");
  const [isConnected, setIsConnected] = useState(false);
  const [activeTab, setActiveTab] = useState("ALL");
  const [copyStatus, setCopyStatus] = useState(false);

  useEffect(() => {
    if ((window as any).electronAPI) {
      const cleanup = (window as any).electronAPI.onUpdateAbtList((data: any) => {
        setIsConnected(true);
        const newItem = {
          ...data,
          id: Math.random().toString(36).substr(2, 9),
          currentStatus: data.result.status,
          finalComment: "",
          history: [{
            timestamp: new Date().toLocaleTimeString(),
            status: data.result.status,
            comment: data.result.message
          }]
        };
        setItems([newItem, ...items]);
      });

      return () => {
        if (typeof cleanup === 'function') cleanup();
      };
    }
  }, [items, setItems]);

  const guidelineTabs = useMemo(() => {
    const ids = Array.from(new Set(items.map(i => i.guideline_id)));
    return ["ALL", ...ids];
  }, [items]);

  const filteredItems = useMemo(() => {
    if (activeTab === "ALL") return items;
    return items.filter(i => i.guideline_id === activeTab);
  }, [items, activeTab]);

  const handleJudge = (id: string, nextStatus: string) => {
    const nextItems = items.map(item => {
      if (item.id === id) {
        return {
          ...item,
          currentStatus: nextStatus,
          finalComment: tempComment,
          history: [...item.history, {
            timestamp: new Date().toLocaleTimeString(),
            status: nextStatus,
            comment: tempComment || "ì „ë¬¸ê°€ íŒì • ì™„ë£Œ"
          }]
        };
      }
      return item;
    });
    setItems(nextItems);
    setJudgingId(null);
    setTempComment("");
  };

  const generateMarkdownReport = () => {
    const date = new Date().toLocaleDateString();
    let md = `# ğŸ›¡ï¸ ABT ì ‘ê·¼ì„± ì§„ë‹¨ ë¦¬í¬íŠ¸ (${date})\n\n`;
    
    const fails = items.filter(i => i.currentStatus === 'ì˜¤ë¥˜').length;
    const inapps = items.filter(i => i.currentStatus === 'ë¶€ì ì ˆ').length;
    const recs = items.filter(i => i.currentStatus === 'ìˆ˜ì • ê¶Œê³ ').length;
    
    md += `## ğŸ“Š ì§„ë‹¨ ìš”ì•½\n`;
    md += `- **âŒ ì˜¤ë¥˜:** ${fails}ê±´\n`;
    md += `- **ğŸš« ë¶€ì ì ˆ:** ${inapps}ê±´\n`;
    md += `- **âš ï¸ ìˆ˜ì • ê¶Œê³ :** ${recs}ê±´\n\n`;
    md += `---\n\n`;

    const activeGuidelines = Array.from(new Set(items.filter(i => i.currentStatus !== 'ì ì ˆ').map(i => i.guideline_id)));
    
    activeGuidelines.forEach(gid => {
      md += `## ğŸ“˜ ${guidelineNames[gid] || gid}\n\n`;
      const gidItems = items.filter(i => i.guideline_id === gid && i.currentStatus !== 'ì ì ˆ');
      
      gidItems.forEach(item => {
        const statusIcon = item.currentStatus === 'ì˜¤ë¥˜' ? 'âŒ' : item.currentStatus === 'ë¶€ì ì ˆ' ? 'ğŸš«' : 'âš ï¸';
        md += `### ${statusIcon} [${item.currentStatus}] ${item.elementInfo.selector}\n`;
        md += `- **ì§„ë‹¨ ê²°ê³¼:** ${item.result.message}\n`;
        if (item.finalComment) md += `- **QA ì „ë¬¸ê°€ ì†Œê²¬:** ${item.finalComment}\n`;
        md += `- **ëŒ€ìƒ ìš”ì†Œ:** \`${item.elementInfo.tagName}\`\n`;
        md += `- **ì£¼ë³€ ë§¥ë½:** *"${item.context.smartContext}"*\n\n`;
      });
    });

    md += `---\n*Generated by ABT (A11Y Browser Tester) Desktop*`;
    
    navigator.clipboard.writeText(md).then(() => {
      setCopyStatus(true);
      setTimeout(() => setCopyStatus(false), 2000);
    });
  };

  const selectedItem = items.find(i => i.id === selectedId);

  return (
    <div className={styles.container}>
      <aside className={styles.sidebar} aria-label="í”„ë¡œì íŠ¸ ë‚´ë¹„ê²Œì´ì…˜">
        <header className={styles.header}>
          <div className={styles.brand}>
            <div className={styles.logoBox}>
              <Shield size={20} strokeWidth={2.5} />
            </div>
            <div className={styles.titleGroup}>
              <h1>ABT Engine</h1>
              <span>Desktop Auditor</span>
            </div>
          </div>
        </header>
        
        <nav className={styles.navArea}>
          <h2>ê²€ìˆ˜ ì„¸ì…˜</h2>
          <ul>
            <li>
              <button className={styles.sessionBtn}>
                <div className={styles.pulse}></div>
                2026-02-20 ë©”ì¸ í˜ì´ì§€
              </button>
            </li>
          </ul>
        </nav>

        <footer className={styles.sidebarFooter}>
          <div className={styles.connStatus}>
            <span>Browser Connection</span>
            <div className={`${styles.badge} ${isConnected ? styles.connected : styles.waiting}`}>
              <div className={styles.dot}></div>
              {isConnected ? 'On' : 'Off'}
            </div>
          </div>
        </footer>
      </aside>

      <main className={styles.mainBoard}>
        <header className={styles.topHeader}>
          <div className={styles.headingArea}>
            <h2>{projectName} - ê²€ìˆ˜ ë³´ë“œ</h2>
            <ul className={styles.summaryStats}>
              <li className={styles.failSummary}>ì˜¤ë¥˜ {items.filter(i => i.currentStatus === 'ì˜¤ë¥˜').length}</li>
              <li className={styles.warnSummary}>ìˆ˜ì • ê¶Œê³  {items.filter(i => i.currentStatus === 'ìˆ˜ì • ê¶Œê³ ').length}</li>
              <li className={styles.reviewSummary}>ê²€í†  í•„ìš” {items.filter(i => i.currentStatus === 'ê²€í†  í•„ìš”').length}</li>
            </ul>
          </div>
          <div className={styles.topActions}>
            <button 
              onClick={clearItems}
              className={styles.clearBtn}
              title="ë°ì´í„° ì´ˆê¸°í™”"
            >
              <Trash2 size={18} />
            </button>
            <button 
              onClick={generateMarkdownReport}
              className={`${styles.reportBtn} ${copyStatus ? styles.copied : styles.ready}`}
            >
              {copyStatus ? <CheckCircle2 size={18} /> : <FileText size={18} />}
              {copyStatus ? "ë¦¬í¬íŠ¸ ë³µì‚¬ë¨!" : "ë¦¬í¬íŠ¸ ì¶”ì¶œ (Jiraìš©)"}
            </button>
          </div>
        </header>

        <nav className={styles.filterNav}>
          <ul>
            <Filter size={14} className={styles.filterIcon} />
            {guidelineTabs.map(tab => (
              <li key={tab}>
                <button
                  onClick={() => setActiveTab(tab)}
                  className={`${styles.tabBtn} ${activeTab === tab ? styles.active : ''}`}
                >
                  {guidelineNames[tab] || tab}
                  <span className={styles.count}>
                    ({items.filter(i => tab === "ALL" || i.guideline_id === tab).length})
                  </span>
                </button>
              </li>
            ))}
          </ul>
        </nav>

        <section className={`${styles.contentArea} ${styles.customScrollbar}`}>
          {filteredItems.length === 0 ? (
            <div className={styles.emptyState}>
              <Search size={40} />
              <p>No Data Detected</p>
            </div>
          ) : (
            filteredItems.map((item) => (
              <article 
                key={item.id} 
                onClick={() => setSelectedId(item.id)}
                className={`${styles.card} ${selectedId === item.id ? styles.selected : ''}`}
              >
                <div className={styles.cardHeader}>
                  <div className={styles.meta}>
                    <span className={styles.badge}>{guidelineNames[item.guideline_id]?.split(' ')[1] || item.guideline_id}</span>
                    <code>{item.elementInfo?.selector}</code>
                  </div>
                  <div className={`${styles.statusTag} ${
                    item.currentStatus === 'ì˜¤ë¥˜' ? styles.fail :
                    item.currentStatus === 'ë¶€ì ì ˆ' ? styles.inappropriate :
                    item.currentStatus === 'ìˆ˜ì • ê¶Œê³ ' ? styles.recommendation :
                    item.currentStatus === 'ê²€í†  í•„ìš”' ? styles.needs_review :
                    styles.pass
                  }`}>
                    {item.currentStatus === 'ì˜¤ë¥˜' && <AlertCircle size={12} />}
                    {item.currentStatus}
                  </div>
                </div>
                
                <div className={styles.mainInfo}>
                  <div className={styles.preview}>
                    {item.elementInfo.tagName === 'VIDEO' ? (
                      <div className={styles.videoIcon}>
                        <Clock size={32} />
                        <span>VIDEO</span>
                      </div>
                    ) : (
                      <img src={item.elementInfo?.src} alt="" />
                    )}
                  </div>
                  <div className={styles.textInfo}>
                    <h3>{item.result?.message}</h3>
                    <div className={styles.contextBox}>
                      <h4>Context Analysis</h4>
                      <p>"...{item.context?.smartContext}..."</p>
                    </div>
                    {item.finalComment && (
                      <div className={styles.commentBox}>
                        <h4>Expert Judgement</h4>
                        <p>{item.finalComment}</p>
                      </div>
                    )}
                  </div>
                </div>

                {judgingId === item.id ? (
                  <div className={styles.judgingArea}>
                    <div className={styles.quickChips}>
                      <button onClick={() => setTempComment("ì£¼ë³€ ì •ë³´ì™€ ì¤‘ë³µë˜ì–´ ì¥ì‹ìš© ì²˜ë¦¬ë¥¼ ìš”ì²­ë“œë¦½ë‹ˆë‹¤.")}>#ì¤‘ë³µì •ë³´</button>
                      <button onClick={() => setTempComment("ê¸°ëŠ¥í˜• ì´ë¯¸ì§€ì— ì ì ˆí•œ ë™ì‘ ì„¤ëª…ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")}>#ì ì ˆí•œë™ì‘</button>
                      <button onClick={() => setTempComment("ë¶ˆí•„ìš”í•œ ìˆ˜ì‹ì–´(ì‚¬ì§„, ì´ë¯¸ì§€) ì‚­ì œë¥¼ ìˆ˜ì • ê¶Œê³ (ìš”ì²­)í•©ë‹ˆë‹¤.")}>#ìˆ˜ì‹ì–´ì‚­ì œ</button>
                    </div>
                    <textarea 
                      value={tempComment}
                      onChange={(e) => setTempComment(e.target.value)}
                      placeholder="ê°œë°œìì—ê²Œ ì „ë‹¬í•  ì •ì„± í‰ê°€ ì˜ê²¬ì„ ì…ë ¥í•˜ì„¸ìš”..."
                    />
                    <div className={styles.btnGroup}>
                      <button onClick={() => setJudgingId(null)} className={styles.cancelBtn}>ì·¨ì†Œ</button>
                      <button onClick={() => handleJudge(item.id, 'ì ì ˆ')} className={styles.passBtn}>ì ì ˆí•¨ í™•ì¸</button>
                      <button onClick={() => handleJudge(item.id, 'ìˆ˜ì • ê¶Œê³ ')} className={styles.recomBtn}>ê°œì„  ê¶Œê³  ìš”ì²­</button>
                      <button onClick={() => handleJudge(item.id, 'ë¶€ì ì ˆ')} className={styles.inappBtn}>ìˆ˜ì • ìš”ì²­ (ë¶€ì ì ˆ)</button>
                    </div>
                  </div>
                ) : (
                  <div className={styles.cardFooter}>
                    <div className={styles.actionGroup}>
                      <button 
                        onClick={(e) => { e.stopPropagation(); setJudgingId(item.id); setTempComment(item.finalComment); }}
                        className={styles.actionBtn}
                      >
                        <Edit3 size={14} /> ìˆ˜ì •
                      </button>
                      {item.currentStatus === 'ê²€í†  í•„ìš”' && (
                        <button 
                          onClick={(e) => { e.stopPropagation(); handleJudge(item.id, 'ì ì ˆ'); }}
                          className={`${styles.actionBtn} ${styles.confirmBtn}`}
                        >
                          <CheckCircle2 size={14} /> ê²€í†  ì™„ë£Œ
                        </button>
                      )}
                    </div>
                    <div className={styles.timestamp}>
                      <Clock size={12} />
                      <span>Last: {item.currentStatus}</span>
                    </div>
                  </div>
                )}
              </article>
            ))
          )}
        </section>
      </main>

      <aside className={styles.propPanel}>
        <h3><div className={styles.indicator}></div> ìƒì„¸ ì†ì„± ë° ì´ë ¥</h3>
        {selectedItem ? (
          <div className={`${styles.propContent} ${styles.customScrollbar}`}>
            <section>
              <h4>Technical Metadata</h4>
              <div className={styles.techMeta}>
                {`<${selectedItem.elementInfo.tagName.toLowerCase()} ...>`}
              </div>
              <div className={styles.tagList}>
                <div className={styles.tagItem}>
                  <label>Tag</label>
                  <span>{selectedItem.elementInfo.tagName}</span>
                </div>
                <div className={styles.tagItem}>
                  <label>ID</label>
                  <span>{selectedItem.guideline_id}</span>
                </div>
              </div>
            </section>
            
            <section>
              <h4>Judgment Timeline</h4>
              <ul className={styles.timeline}>
                {selectedItem.history.map((log: any, i: number) => (
                  <li key={i}>
                    <div className={styles.dot}></div>
                    <time>{log.timestamp}</time>
                    <div className={styles.logStatus}>{log.status}</div>
                    <p className={styles.logComment}>"{log.comment}"</p>
                  </li>
                ))}
              </ul>
            </section>

            <section>
              <h4>Compliance Guide</h4>
              <div className={styles.guideBox}>
                <Info size={20} style={{ flexShrink: 0 }} />
                <p>
                  {selectedItem.guideline_id === '1.1' ? "í…ìŠ¤íŠ¸ê°€ ì•„ë‹Œ ì½˜í…ì¸ ì—ëŠ” ê·¸ ì˜ë¯¸ë‚˜ ìš©ë„ë¥¼ ì•Œ ìˆ˜ ìˆë„ë¡ ëŒ€ì²´ í…ìŠ¤íŠ¸ë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤." : 
                   selectedItem.guideline_id === '1.2' ? "ë©€í‹°ë¯¸ë””ì–´ ì½˜í…ì¸ ì—ëŠ” ìë§‰, ëŒ€ë³¸ ë˜ëŠ” ìˆ˜ì–´ë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤." : 
                   "ì›¹ ì ‘ê·¼ì„± ì¤€ìˆ˜ ì§€ì¹¨ì— ë”°ë¼ ì ì ˆí•œ ëŒ€ì²´ ìˆ˜ë‹¨ì„ ì œê³µí•˜ì„¸ìš”."}
                </p>
              </div>
            </section>
          </div>
        ) : (
          <div className={styles.emptyProp}>
            <ChevronRight size={32} />
            <p>Select an item to view details</p>
          </div>
        )}
      </aside>
    </div>
  );
};

export default App;
