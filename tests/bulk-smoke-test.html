<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ABT Engine Bulk Smoke Test (All Processors)</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; padding: 20px; background: #0f172a; color: #f1f5f9; }
        .dashboard { max-width: 1000px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        h1 { font-size: 1.5rem; margin: 0; color: #38bdf8; }
        .btn { background: #0ea5e9; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn:hover { background: #0284c7; }
        .stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-card { background: #1e293b; padding: 15px; border-radius: 8px; flex: 1; text-align: center; border: 1px solid #334155; }
        .stat-val { font-size: 1.5rem; font-weight: 800; display: block; }
        .stat-label { font-size: 0.8rem; color: #94a3b8; }
        
        table { width: 100%; border-collapse: collapse; background: #1e293b; border-radius: 8px; overflow: hidden; }
        th { background: #334155; text-align: left; padding: 12px; font-size: 0.9rem; }
        td { padding: 12px; border-bottom: 1px solid #334155; font-size: 0.85rem; }
        .status-badge { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .bg-ok { background: #065f46; color: #34d399; }
        .bg-err { background: #7f1d1d; color: #f87171; }
        .bg-wait { background: #475569; color: #cbd5e1; }
        
        .log-panel { margin-top: 20px; background: #000; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; color: #10b981; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #111; padding-bottom: 2px; }
        .log-err { color: #f87171; }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>ABT Engine Bulk Smoke Test</h1>
            <button id="run-all" class="btn">Run All Scans</button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <span id="total-count" class="stat-val">0</span>
                <span class="stat-label">Total Processors</span>
            </div>
            <div class="stat-card">
                <span id="pass-count" class="stat-val">0</span>
                <span class="stat-label">Passed</span>
            </div>
            <div class="stat-card">
                <span id="fail-count" class="stat-val" style="color: #f87171;">0</span>
                <span class="stat-label">Failed</span>
            </div>
        </div>

        <table id="results-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Registration</th>
                    <th>Scan Status</th>
                    <th>Findings</th>
                    <th>Duration</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be added here -->
            </tbody>
        </table>

        <div id="log" class="log-panel">
            <div class="log-entry">[System] Test initialized. Mocking Chrome Runtime...</div>
        </div>
    </div>

    <!-- 1. Mocks -->
    <script>
        window.chrome = {
            runtime: {
                onMessage: {
                    addListener: () => console.log("[Mock] chrome.runtime.onMessage.addListener called")
                },
                sendMessage: (msg, callback) => {
                    // console.log("[Mock] chrome.runtime.sendMessage called", msg);
                    if (callback) callback({ status: 'mock_ok' });
                }
            }
        };
        
        function log(msg, isError = false) {
            const logPanel = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry' + (isError ? ' log-err' : '');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }
    </script>

    <!-- 2. Load Core -->
    <script src="../src/engine/ABT-Shared-Utils.js"></script>
    <script src="../src/engine/ABT-Connector.js"></script>
    <script src="../src/engine/ABT-Core.js"></script>

    <!-- 3. Load Processors Dynamically -->
    <script>
        const processorIds = [
            "1.1.1", "1.2.1", "1.3.1", "1.3.2", "1.3.3", "1.4.1", "1.4.2", "1.4.3", "1.4.4",
            "2.1.1", "2.1.2", "2.1.3", "2.1.4", "2.2.1", "2.2.2", "2.3.1", "2.4.1", "2.4.2", "2.4.3", "2.4.4",
            "2.5.1", "2.5.2", "2.5.3", "2.5.4", "3.1.1", "3.2.1", "3.2.2", "3.3.1", "3.3.2", "3.3.3", "3.3.4",
            "4.1.1", "4.2.1"
        ];

        async function loadProcessors() {
            log(`Loading ${processorIds.length} processors...`);
            const tbody = document.querySelector('#results-table tbody');
            
            for (const id of processorIds) {
                const tr = document.createElement('tr');
                tr.id = `row-${id.replace(/\./g, '-')}`;
                tr.innerHTML = `
                    <td><strong>${id}</strong></td>
                    <td class="reg-status"><span class="status-badge bg-wait">LOADING</span></td>
                    <td class="scan-status"><span class="status-badge bg-wait">WAITING</span></td>
                    <td class="findings">-</td>
                    <td class="duration">-</td>
                `;
                tbody.appendChild(tr);

                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = `../src/engine/processors/Processor-${id.replace(/\./g, '')}.js`;
                        script.onload = resolve;
                        script.onerror = () => reject(new Error(`Failed to load Processor-${id}`));
                        document.head.appendChild(script);
                    });
                    
                    const regCell = tr.querySelector('.reg-status');
                    if (window.ABTCore.processors.has(id)) {
                        regCell.innerHTML = '<span class="status-badge bg-ok">REGISTERED</span>';
                    } else {
                        regCell.innerHTML = '<span class="status-badge bg-err">FAILED</span>';
                        log(`Processor [${id}] was loaded but not registered to ABTCore.`, true);
                    }
                } catch (err) {
                    log(err.message, true);
                    tr.querySelector('.reg-status').innerHTML = '<span class="status-badge bg-err">LOAD ERROR</span>';
                }
            }
            document.getElementById('total-count').textContent = window.ABTCore.processors.size;
        }

        async function runScans() {
            log("Starting Bulk Scan...");
            let passed = 0;
            let failed = 0;
            
            const processors = Array.from(window.ABTCore.processors.entries());
            
            for (const [id, processor] of processors) {
                const tr = document.getElementById(`row-${id.replace(/\./g, '-')}`);
                const scanCell = tr.querySelector('.scan-status');
                const findingsCell = tr.querySelector('.findings');
                const durationCell = tr.querySelector('.duration');
                
                scanCell.innerHTML = '<span class="status-badge bg-wait">SCANNING</span>';
                
                const start = performance.now();
                try {
                    const reports = await processor.scan();
                    const end = performance.now();
                    
                    scanCell.innerHTML = '<span class="status-badge bg-ok">OK</span>';
                    findingsCell.textContent = `${reports.length} items`;
                    durationCell.textContent = `${(end - start).toFixed(2)}ms`;
                    passed++;
                    log(`Processor [${id}] scan completed: ${reports.length} items found.`);
                } catch (err) {
                    const end = performance.now();
                    scanCell.innerHTML = '<span class="status-badge bg-err">ERROR</span>';
                    durationCell.textContent = `${(end - start).toFixed(2)}ms`;
                    log(`Processor [${id}] failed: ${err.message}`, true);
                    console.error(err);
                    failed++;
                }
                
                document.getElementById('pass-count').textContent = passed;
                document.getElementById('fail-count').textContent = failed;
            }
            
            log(`Bulk Scan Complete. Passed: ${passed}, Failed: ${failed}`);
        }

        window.onload = async () => {
            await loadProcessors();
            document.getElementById('run-all').onclick = runScans;
        };
    </script>
</body>
</html>
